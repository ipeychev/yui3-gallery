YUI.add("gallery-undo",function(A){(function(){function C(Q){C.superclass.constructor.apply(this,arguments);}var F=A.Lang,M="UndoManager",L="actionAdded",P="beforeCanceling",J="actionCanceled",H="cancelingFinished",B="beforeUndo",K="actionUndone",G="undoFinished",N="beforeRedo",E="redoFinished",I="actionRedone",D="asyncProcessing",O=0;A.mix(C,{NAME:M,ATTRS:{limit:{value:O,validator:function(Q){return F.isNumber(Q)&&Q>=0;}},undoIndex:{readOnly:true,getter:function(){return this._undoIndex;}}}});A.extend(C,A.Base,{_actions:[],_undoIndex:0,_actionHandle:null,_processing:false,initializer:function(Q){this._initEvents();this.after("limitChange",A.bind(this._afterLimit,this));},destructor:function(){this.purgeAll();},_initEvents:function(){this.publish(L);this.publish(P);this.publish(J);this.publish(H);this.publish(B);this.publish(K);this.publish(G);this.publish(N);this.publish(I);this.publish(E);},add:function(U){var T=null,V,S,R,Q=false;if(this._processing){return false;}V=this._actions;S=this._undoIndex;if(S>0){T=V[S-1];}if(S<V.length){this.fire(P);while(S<V.length){R=V.splice(-1,1)[0];R.cancel();this.fire(J,{action:R,index:V.length});}this.fire(H);}if(T){Q=T.merge(U);if(!Q){V.push(U);}}else{V.push(U);}this._limitActions();if(!Q){this._undoIndex++;this.fire(L,U);}return true;},_limitActions:function(S){var U,R,Z,Q,a,X,W,Y,V,T;if(!S){S=this.get("limit");}if(S===O){return;}U=this._actions;if(U.length<=S){return;}Y=this._undoIndex;Z=parseInt(S/2,10);Q=S-Z;a=S-Q;X=Y-Q;W=U.length-Y-a;if(X<0){W+=X;}else{if(W<0){X+=W;}}if(X>0||W>0){this.fire(P);for(V=0;V<X;V++){this._undoIndex--;R=U.splice(0,1)[0];R.cancel();this.fire(J,{"action":R,index:0});}for(V=U.length-1,T=0;T<W;V--,T++){R=U.splice(V,1)[0];R.cancel();this.fire(J,{"action":R,index:V});}this.fire(H);}},_afterLimit:function(Q){this._limitActions(Q.newVal);},undo:function(){if(this.canUndo()){this._undoTo(this._undoIndex-1);}},redo:function(){if(this.canRedo()){this._redoTo(this._undoIndex+1);}},canUndo:function(){return !this._processing&&this._undoIndex>0;},canRedo:function(){return !this._processing&&this._undoIndex<this._actions.length;},getUndoLabel:function(){var Q;if(this.canUndo()){Q=this._actions[this._undoIndex-1];return Q.get("label");}return null;},getRedoLabel:function(){var Q;if(this.canRedo()){Q=this._actions[this._undoIndex];return Q.get("label");}return null;},purgeAll:function(){this.purgeTo(0);},purgeTo:function(Q){var S,R;for(R=this._actions.length-1;R>=Q;R--){S=this._actions.splice(R,1)[0];S.cancel();this.fire(J,{"action":S,index:R});}if(this._undoIndex>Q){this._undoIndex=Q;}this._processing=false;},processTo:function(Q){if(F.isNumber(Q)&&!this._processing&&Q>=0&&Q<=this._actions.length){if(this._undoIndex<Q){this._redoTo(Q);}else{if(this._undoIndex>Q){this._undoTo(Q);}}}},_redoTo:function(Q){var R=this._actions[this._undoIndex++];if(!this._processing){this.fire(N);this._processing=true;}if(!R.get(D)){R.redo();this.fire(I,{"action":R,index:this._undoIndex-1});if(this._undoIndex<Q){this._redoTo(Q);}else{this._processing=false;this.fire(E);}}else{this._actionHandle=R.on(E,A.bind(this._onAsyncRedoFinished,this,R,Q));R.redo();}},_undoTo:function(Q){var R=this._actions[--this._undoIndex];if(!this._processing){this.fire(B);this._processing=true;}if(!R.get(D)){R.undo();this.fire(K,{"action":R,index:this._undoIndex});if(this._undoIndex>Q){this._undoTo(Q);}else{this._processing=false;this.fire(G);}}else{this._actionHandle=R.on(G,A.bind(this._onAsyncUndoFinished,this,R,Q));R.undo();}},_onAsyncUndoFinished:function(R,Q){this._actionHandle.detach();this._actionHandle=null;this.fire(K,{"action":R,index:this._undoIndex});if(this._undoIndex>Q){this._undoTo(Q);}else{this._processing=false;this.fire(G,R);}},_onAsyncRedoFinished:function(R,Q){this._actionHandle.detach();this._actionHandle=null;this.fire(I,{"action":R,index:this._undoIndex-1});if(this._undoIndex<Q){this._redoTo(Q);}else{this._processing=false;this.fire(E,R);}}});A.UndoManager=C;}());(function(){function H(J){H.superclass.constructor.apply(this,arguments);}var G=A.Lang,I="UndoableAction",C="label",E="beforeUndo",B="undoFinished",F="beforeRedo",D="redoFinished";A.mix(H,{NAME:I,ATTRS:{label:{value:"",validator:G.isString},asyncProcessing:{value:false,validator:G.isBoolean}}});A.extend(H,A.Base,{_childActions:[],initializer:function(J){this._initEvents();},destructor:function(){},_initEvents:function(){this.publish(E);this.publish(B);this.publish(F);this.publish(D);},undo:function(){var L,K,J;this.fire(E);L=this._childActions;for(J=L.length-1;J>0;J--){K=L[J];K.undo();}this.fire(B);},redo:function(){var M,L,J,K;this.fire(F);M=this._childActions;K=M.length;for(J=0;J<K;J++){L=M[J];L.redo();}this.fire(D);},merge:function(J){return false;},cancel:function(){},toString:function(){return this.get(C);}});A.UndoableAction=H;}());},"@VERSION@",{requires:["base","event"]});