YUI.add("gallery-undo",function(A){(function(){function C(M){C.superclass.constructor.apply(this,arguments);}var E=A.Lang,I="UndoManager",H="actionAdded",G="undoCanceled",B="beforeUndo",L="undoPerformed",J="beforeRedo",F="redoPerformed",D="asyncProcessing",K=0;C.NAME=I;C.ATTRS={limit:{value:K,validator:function(M){return E.isNumber(M)&&M>=0;}}};A.extend(C,A.Base,{_actions:[],_undoIndex:0,_actionHandle:null,_processing:false,initializer:function(M){this._initEvents();this.after("limitChange",A.bind(this._afterLimit,this));},destructor:function(){this.purgeAll();},_initEvents:function(){this.publish(H);this.publish(G);this.publish(B);this.publish(L);this.publish(J);this.publish(F);},add:function(P){var O=null,Q,N,M;if(this._processing){return false;}Q=this._actions;N=this._undoIndex;if(N>0){O=Q[N-1];}while(N<Q.length){M=Q.splice(-1,1)[0];M.cancel();this.fire(G,{"action":M});}if(O){if(!O.merge(P)){Q.push(P);}}else{Q.push(P);}this._limitActions();this._undoIndex++;this.fire(H,P);return true;},_limitActions:function(O){var Q,N,V,M,W,T,S,U,R,P;if(!O){O=this.get("limit");}if(O===K){return;}Q=this._actions;if(Q.length<=O){return;}U=this._undoIndex;V=parseInt(O/2,10);M=O-V;W=O-M;T=U-M;S=Q.length-U-W;if(T<0){S+=T;}else{if(S<0){T+=S;}}for(R=0;R<T;R++){this._undoIndex--;N=Q.splice(0,1)[0];N.cancel();this.fire(G,{"action":N});}for(R=Q.length-1,P=0;P<S;R--,P++){N=Q.splice(R,1)[0];N.cancel();this.fire(G,{"action":N});}},_afterLimit:function(M){this._limitActions(M.newVal);},undo:function(){if(this.canUndo()){this._undoTo(this._undoIndex-1);}},redo:function(){if(this.canRedo()){this._redoTo(this._undoIndex+1);}},canUndo:function(){return !this._processing&&this._undoIndex>0;},canRedo:function(){return !this._processing&&this._undoIndex<this._actions.length;},getUndoLabel:function(){var M;if(this.canUndo()){M=this._actions[this._undoIndex-1];return M.get("label");}return null;},getRedoLabel:function(){var M;if(this.canRedo()){M=this._actions[this._undoIndex];return M.get("label");}return null;},purgeAll:function(){var N,M;for(M=this._actions.length-1;M>=0;M--){N=this._actions.splice(M,1)[0];N.cancel();this.fire(G,{"action":N});}this._undoIndex=0;this._processing=false;},processTo:function(M){if(E.isNumber(M)&&this.canUndo()&&this.canRedo()){if(this._undoIndex<M){this._redoTo(M);}else{if(this._undoIndex>M){this._undoTo(M);}}}},_redoTo:function(M){var N=this._actions[this._undoIndex];if(!N.get(D)){this._processing=true;this.fire(J,N);this._undoIndex++;N.redo();this.fire(F,N);if(this._undoIndex<M){this._redoTo(M);}else{this._processing=false;}}else{this._processing=true;this._actionHandle=N.on(F,A.bind(this._onAsyncRedoPerformed,this,N,M));this.fire(J,N);this._undoIndex++;N.redo();}},_undoTo:function(M){var N=this._actions[this._undoIndex-1];if(!N.get(D)){this._processing=true;this.fire(B,N);this._undoIndex--;N.undo();this.fire(L,N);if(this._undoIndex>M){this._undoTo(M);}else{this._processing=false;}}else{this._processing=true;N=this._actions[this._undoIndex-1];this._actionHandle=N.on(L,A.bind(this._onAsyncUndoPerformed,this,N,M));this.fire(B,N);this._undoIndex--;N.undo();}},_onAsyncUndoPerformed:function(N,M){this._actionHandle.detach();this._actionHandle=null;this.fire(L,N);if(this._undoIndex>M){this._undoTo(M);}else{this._processing=false;}},_onAsyncRedoPerformed:function(N,M){this._actionHandle.detach();this._actionHandle=null;this.fire(F,N);if(this._undoIndex<M){this._redoTo(M);}else{this._processing=false;}}});A.UndoManager=C;}());(function(){function G(J){G.superclass.constructor.apply(this,arguments);}var F=A.Lang,I="UndoableAction",C="label",D="beforeUndo",B="undoPerformed",E="beforeRedo",H="redoPerformed";G.NAME=I;G.ATTRS={label:{value:"",validator:F.isString},asyncProcessing:{value:false,validator:F.isBoolean}};A.extend(G,A.Base,{_childActions:[],initializer:function(J){this._initEvents();},destructor:function(){},_initEvents:function(){this.publish(D);this.publish(B);this.publish(E);this.publish(H);},undo:function(){var L,K,J;this.fire(D);L=this._childActions;for(J=L.length-1;J>0;J--){K=L[J];K.undo();}this.fire(B);},redo:function(){var M,L,J,K;this.fire(D);M=this._childActions;K=M.length;for(J=0;J<K;J++){L=M[J];L.redo();}this.fire(H);},merge:function(J){return false;},cancel:function(){},toString:function(){return this.get(C);}});A.UndoableAction=G;}());},"@VERSION@",{requires:["base","event"]});