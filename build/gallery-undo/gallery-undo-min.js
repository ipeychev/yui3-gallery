YUI.add("gallery-undo",function(A){(function(){function C(R){C.superclass.constructor.apply(this,arguments);}var F=A.Lang,M="UndoManager",L="actionAdded",P="actionMerged",Q="beforeCanceling",J="actionCanceled",H="cancelingFinished",B="beforeUndo",K="actionUndone",G="undoFinished",N="beforeRedo",E="redoFinished",I="actionRedone",D="asyncProcessing",O=0;A.mix(C,{NAME:M,ATTRS:{limit:{value:O,validator:function(R){return F.isNumber(R)&&R>=0;}},undoIndex:{readOnly:true,getter:function(){return this._undoIndex;}}}});A.extend(C,A.Base,{_actions:[],_undoIndex:0,_actionHandle:null,_processing:false,initializer:function(R){this._initEvents();this.after("limitChange",A.bind(this._afterLimit,this));},destructor:function(){this.purgeAll();},_initEvents:function(){this.publish(L);this.publish(P);this.publish(Q);this.publish(J);this.publish(H);this.publish(B);this.publish(K);this.publish(G);this.publish(N);this.publish(I);this.publish(E);},add:function(V){var U=null,W,T,S,R=false;if(this._processing){return false;}W=this._actions;T=this._undoIndex;if(T>0){U=W[T-1];}if(T<W.length){this.fire(Q);while(T<W.length){S=W.splice(-1,1)[0];S.cancel();this.fire(J,{action:S,index:W.length});}this.fire(H);}if(U){R=U.merge(V);if(!R){W.push(V);}}else{W.push(V);}if(!R){this._undoIndex++;this._limitActions();this.fire(L,V);}else{this.fire(P,U,V);}return true;},_limitActions:function(T){var V,S,a,R,b,Y,X,Z,W,U;if(!T){T=this.get("limit");}if(T===O){return;}V=this._actions;if(V.length<=T){return;}Z=this._undoIndex;a=parseInt(T/2,10);R=T-a;b=T-R;Y=Z-R;X=V.length-Z-b;if(Y<0){X+=Y;}else{if(X<0){Y+=X;}}if(Y>0||X>0){this.fire(Q);for(W=0;W<Y;W++){this._undoIndex--;S=V.splice(0,1)[0];S.cancel();this.fire(J,{"action":S,index:0});}for(W=V.length-1,U=0;U<X;W--,U++){S=V.splice(W,1)[0];S.cancel();this.fire(J,{"action":S,index:W});}this.fire(H);}},_afterLimit:function(R){this._limitActions(R.newVal);},undo:function(){if(this.canUndo()){this._undoTo(this._undoIndex-1);}},redo:function(){if(this.canRedo()){this._redoTo(this._undoIndex+1);}},canUndo:function(){return !this._processing&&this._undoIndex>0;},canRedo:function(){return !this._processing&&this._undoIndex<this._actions.length;},getUndoLabel:function(){var R;if(this.canUndo()){R=this._actions[this._undoIndex-1];return R.get("label");}return null;},getRedoLabel:function(){var R;if(this.canRedo()){R=this._actions[this._undoIndex];return R.get("label");}return null;},purgeAll:function(){this.purgeTo(0);},purgeTo:function(R){var T,S;for(S=this._actions.length-1;S>=R;S--){T=this._actions.splice(S,1)[0];T.cancel();this.fire(J,{"action":T,index:S});}if(this._undoIndex>R){this._undoIndex=R;}this._processing=false;},processTo:function(R){if(F.isNumber(R)&&!this._processing&&R>=0&&R<=this._actions.length){if(this._undoIndex<R){this._redoTo(R);}else{if(this._undoIndex>R){this._undoTo(R);}}}},_redoTo:function(R){var S=this._actions[this._undoIndex++];if(!this._processing){this.fire(N);this._processing=true;}if(!S.get(D)){S.redo();this.fire(I,{"action":S,index:this._undoIndex-1});if(this._undoIndex<R){this._redoTo(R);}else{this._processing=false;this.fire(E);}}else{this._actionHandle=S.on(E,A.bind(this._onAsyncRedoFinished,this,S,R));S.redo();}},_undoTo:function(R){var S=this._actions[--this._undoIndex];if(!this._processing){this.fire(B);this._processing=true;}if(!S.get(D)){S.undo();this.fire(K,{"action":S,index:this._undoIndex});if(this._undoIndex>R){this._undoTo(R);}else{this._processing=false;this.fire(G);}}else{this._actionHandle=S.on(G,A.bind(this._onAsyncUndoFinished,this,S,R));S.undo();}},_onAsyncUndoFinished:function(S,R){this._actionHandle.detach();this._actionHandle=null;this.fire(K,{"action":S,index:this._undoIndex});if(this._undoIndex>R){this._undoTo(R);}else{this._processing=false;this.fire(G,S);}},_onAsyncRedoFinished:function(S,R){this._actionHandle.detach();this._actionHandle=null;this.fire(I,{"action":S,index:this._undoIndex-1});if(this._undoIndex<R){this._redoTo(R);}else{this._processing=false;this.fire(E,S);}}});A.UndoManager=C;}());(function(){function H(J){H.superclass.constructor.apply(this,arguments);}var G=A.Lang,I="UndoableAction",C="label",E="beforeUndo",B="undoFinished",F="beforeRedo",D="redoFinished";A.mix(H,{NAME:I,ATTRS:{label:{value:"",validator:G.isString},asyncProcessing:{value:false,validator:G.isBoolean}}});A.extend(H,A.Base,{_childActions:[],initializer:function(J){this._initEvents();},destructor:function(){},_initEvents:function(){this.publish(E);this.publish(B);this.publish(F);this.publish(D);},undo:function(){var L,K,J;this.fire(E);L=this._childActions;for(J=L.length-1;J>0;J--){K=L[J];K.undo();}this.fire(B);},redo:function(){var M,L,J,K;this.fire(F);M=this._childActions;K=M.length;for(J=0;J<K;J++){L=M[J];L.redo();}this.fire(D);},merge:function(J){return false;},cancel:function(){},toString:function(){return this.get(C);}});A.UndoableAction=H;}());},"@VERSION@",{requires:["base","event"]});